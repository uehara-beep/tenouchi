// @ts-nocheck
"use client";
import { useState, useEffect } from "react";
interface Expense { id: string; amount: number; category: string; description: string; date: string; created_at: string; }
interface MoneyPageProps { theme: any; isSecret?: boolean; userId?: string; }
const CAT_COLORS: Record<string,string> = { "食費":"#4ADE80", "交通費":"#60A5FA", "交際費":"#F472B6", "消耗品費":"#FBBF24", "通信費":"#A78BFA", "家賃":"#FB923C", "光熱費":"#34D399", "その他":"#94A3B8" };
export function MoneyPage({ theme, isSecret, userId }: MoneyPageProps) {
  const [expenses, setExpenses] = useState<Expense[]>([]);
  const [loading, setLoading] = useState(true);
  const [period, setPeriod] = useState<"month"|"week"|"all">("month");
  useEffect(() => { loadExpenses(); }, []);
  const loadExpenses = async () => {
    try {
      const { supabase } = await import("@/lib/supabase");
      const { data: { user } } = await supabase.auth.getUser();
      const uid = userId || user?.id;
      if (!uid) { setLoading(false); return; }
      const res = await fetch(`/api/expenses?userId=${uid}`);
      const json = await res.json();
      if (json.expenses) setExpenses(json.expenses);
    } catch (e) { console.error(e); }
    setLoading(false);
  };
  const deleteExpense = async (id: string) => {
    if (!confirm("この記録を削除しますか？")) return;
    await fetch("/api/expenses", { method:"DELETE", headers:{"Content-Type":"application/json"}, body:JSON.stringify({id}) });
    setExpenses(prev => prev.filter(e => e.id !== id));
  };
  const now = new Date();
  const filtered = expenses.filter(e => {
    if (period === "all") return true;
    const d = new Date(e.date);
    if (period === "month") return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
    if (period === "week") { const w = new Date(now); w.setDate(now.getDate()-7); return d >= w; }
    return true;
  });
  const totalExpense = filtered.filter(e => e.type !== "income").reduce((s,e) => s+e.amount, 0);
  const totalIncome = filtered.filter(e => e.type === "income").reduce((s,e) => s+e.amount, 0);
  const total = totalIncome - totalExpense;
  const catTotals: Record<string,number> = {};
  filtered.forEach(e => { catTotals[e.category] = (catTotals[e.category]||0)+e.amount; });
  const catEntries = Object.entries(catTotals).sort((a,b) => b[1]-a[1]);
  const accent = theme?.accent || "#4A9EFF";
  return (
    <div style={{ padding:"70px 16px 100px" }}>
      <div style={{ fontSize:10, fontWeight:700, letterSpacing:5, fontFamily:"'Orbitron',sans-serif", color:accent, opacity:0.8, marginBottom:16 }}>MONEY</div>
      <div style={{ padding:"24px 20px", borderRadius:18, background:"rgba(255,255,255,0.04)", border:"1px solid rgba(255,255,255,0.06)", marginBottom:20 }}>
        <div style={{ fontSize:10, opacity:0.4, letterSpacing:3, fontFamily:"'Orbitron',sans-serif", marginBottom:8 }}>TOTAL</div>
        <div style={{ fontSize:36, fontWeight:900, fontFamily:"'Orbitron',sans-serif", letterSpacing:-1, color: total >= 0 ? "#4ADE80" : "#F472B6" }}>¥{Math.abs(total).toLocaleString()}</div>
        <div style={{ display:"flex", gap:20, marginTop:8 }}>
          <span style={{ fontSize:12, color:"#4ADE80" }}>+¥{totalIncome.toLocaleString()}</span>
          <span style={{ fontSize:12, color:"#F472B6" }}>-¥{totalExpense.toLocaleString()}</span>
        </div>
        <div style={{ fontSize:11, opacity:0.4, marginTop:4 }}>{period==="month"?`${now.getMonth()+1}月の支出`:period==="week"?"今週の支出":"全期間"} / {filtered.length}件</div>
      </div>
      <div style={{ display:"flex", gap:6, marginBottom:20 }}>
        {(["week","month","all"] as const).map(p => (
          <button key={p} onClick={() => setPeriod(p)} style={{ flex:1, padding:"8px 0", borderRadius:8, border:period===p?`1px solid ${accent}`:"1px solid rgba(255,255,255,0.08)", background:period===p?`${accent}15`:"transparent", color:period===p?accent:"rgba(255,255,255,0.4)", fontSize:11, fontWeight:600, cursor:"pointer" }}>
            {p==="week"?"今週":p==="month"?"今月":"全て"}
          </button>
        ))}
      </div>
      {catEntries.length > 0 && (
        <div style={{ marginBottom:20 }}>
          <div style={{ fontSize:10, opacity:0.4, letterSpacing:3, fontFamily:"'Orbitron',sans-serif", marginBottom:12 }}>CATEGORY</div>
          {catEntries.map(([cat,amt]) => {
            const pct = total>0?(amt/total)*100:0;
            const color = CAT_COLORS[cat]||"#94A3B8";
            return (
              <div key={cat} style={{ marginBottom:12 }}>
                <div style={{ display:"flex", justifyContent:"space-between", marginBottom:4 }}>
                  <span style={{ fontSize:13, fontWeight:600 }}>{cat}</span>
                  <span style={{ fontSize:12, opacity:0.6 }}>¥{amt.toLocaleString()}</span>
                </div>
                <div style={{ height:4, borderRadius:2, background:"rgba(255,255,255,0.06)" }}>
                  <div style={{ height:4, borderRadius:2, background:color, width:`${pct}%`, transition:"width 0.6s ease" }} />
                </div>
              </div>
            );
          })}
        </div>
      )}
      <div style={{ fontSize:10, opacity:0.4, letterSpacing:3, fontFamily:"'Orbitron',sans-serif", marginBottom:12 }}>RECENT</div>
      {loading ? (
        <div style={{ textAlign:"center", padding:40, opacity:0.3 }}>読み込み中...</div>
      ) : filtered.length === 0 ? (
        <div style={{ textAlign:"center", padding:"40px 20px", opacity:0.3 }}>
          <div style={{ fontSize:13 }}>記録がありません</div>
          <div style={{ fontSize:11, marginTop:4 }}>秘書に「2万使った 交際費」と伝えてください</div>
        </div>
      ) : (
        filtered.map(e => {
          const color = CAT_COLORS[e.category]||"#94A3B8";
          const d = new Date(e.date);
          return (
            <div key={e.id} style={{ display:"flex", alignItems:"center", gap:12, padding:"12px 14px", borderRadius:12, background:"rgba(255,255,255,0.03)", border:"1px solid rgba(255,255,255,0.05)", marginBottom:6 }}>
              <div style={{ width:36, height:36, borderRadius:10, background:`${color}15`, border:`1px solid ${color}30`, display:"flex", alignItems:"center", justifyContent:"center", fontSize:14, fontWeight:700, color }}>¥</div>
              <div style={{ flex:1 }}>
                <div style={{ fontSize:13, fontWeight:600 }}>{e.category}</div>
                <div style={{ fontSize:11, opacity:0.4 }}>{d.getMonth()+1}/{d.getDate()}{e.description?` - ${e.description.slice(0,20)}`:""}</div>
              </div>
              <div style={{ fontSize:14, fontWeight:700, color: e.type==="income"?"#4ADE80":color }}>{e.type==="income"?"+":"-"}¥{e.amount.toLocaleString()}</div>
              <button onClick={() => deleteExpense(e.id)} style={{ background:"none", border:"none", color:"rgba(255,255,255,0.2)", fontSize:16, cursor:"pointer", padding:"4px 8px" }}>x</button>
            </div>
          );
        })
      )}
    </div>
  );
}
