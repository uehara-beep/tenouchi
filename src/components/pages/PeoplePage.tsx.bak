// @ts-nocheck
"use client";
import { useState, useEffect } from "react";

interface Contact {
  id: string;
  name: string;
  name_reading: string;
  company: string;
  title: string;
  department: string;
  email: string;
  phone: string;
  mobile: string;
  fax: string;
  postal_code: string;
  address: string;
  website: string;
  license: string;
  notes: string;
  source: string;
  created_at: string;
}

interface Props {
  theme: any;
  userId?: string;
}

export function PeoplePage({ theme, userId }: Props) {
  const [contacts, setContacts] = useState<Contact[]>([]);
  const [loading, setLoading] = useState(true);
  const [search, setSearch] = useState("");
  const [selected, setSelected] = useState<Contact | null>(null);
  const [editing, setEditing] = useState<Contact | null>(null);
  const [showAdd, setShowAdd] = useState(false);

  useEffect(() => {
    loadContacts();
  }, []);

  const loadContacts = async () => {
    try {
      const { supabase } = await import("@/lib/supabase");
      const { data: { user } } = await supabase.auth.getUser();
      const uid = userId || user?.id;
      if (!uid) { setLoading(false); return; }
      const res = await fetch(`/api/contacts?userId=${uid}`);
      const data = await res.json();
      setContacts(data.contacts || []);
    } catch (e) {
      console.error("Contacts load error:", e);
    }
    setLoading(false);
  };

  const deleteContact = async (id: string) => {
    if (!confirm("ã“ã®é€£çµ¡å…ˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    try {
      await fetch(`/api/contacts?id=${id}&userId=${userId}`, { method: "DELETE" });
      setContacts(prev => prev.filter(c => c.id !== id));
      setSelected(null);
    } catch (e) {
      alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
  };

  const saveEdit = async () => {
    if (!editing) return;
    try {
      const res = await fetch("/api/contacts", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ...editing, userId }),
      });
      const data = await res.json();
      if (data.contact) {
        setContacts(prev => prev.map(c => c.id === data.contact.id ? data.contact : c));
        setEditing(null);
        setSelected(data.contact);
      }
    } catch (e) {
      alert("æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
  };

  const saveNew = async (contact: Partial<Contact>) => {
    try {
      const res = await fetch("/api/contacts", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ...contact, userId, source: "manual" }),
      });
      const data = await res.json();
      if (data.contact) {
        setContacts(prev => [data.contact, ...prev]);
        setShowAdd(false);
      }
    } catch (e) {
      alert("è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
  };

  const filtered = contacts.filter(c => {
    if (!search) return true;
    const s = search.toLowerCase();
    return (c.name + c.company + c.email + c.phone + c.mobile + c.title).toLowerCase().includes(s);
  });

  const accent = theme?.accent || "#4A9EFF";

  return (
    <div style={{ padding: "70px 16px 16px" }}>
      {/* Header */}
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 16 }}>
        <div style={{ fontSize: 10, fontWeight: 700, letterSpacing: 5, fontFamily: "'Orbitron',sans-serif", color: accent, opacity: 0.8 }}>
          CONTACTS
        </div>
        <button
          onClick={() => setShowAdd(true)}
          style={{ padding: "6px 14px", borderRadius: 8, border: "none", background: `linear-gradient(135deg,${accent},${theme?.accent2 || "#7B61FF"})`, color: "#fff", fontSize: 11, fontWeight: 700, cursor: "pointer" }}
        >
          ï¼‹ è¿½åŠ 
        </button>
      </div>

      {/* Search */}
      <input
        value={search}
        onChange={e => setSearch(e.target.value)}
        placeholder="åå‰ãƒ»ä¼šç¤¾åã§æ¤œç´¢..."
        style={{ width: "100%", padding: "10px 14px", borderRadius: 10, border: "1px solid rgba(255,255,255,0.08)", background: "rgba(255,255,255,0.04)", color: "#F0F0F5", fontSize: 13, outline: "none", boxSizing: "border-box", marginBottom: 16 }}
      />

      {/* Count */}
      <div style={{ fontSize: 11, opacity: 0.4, marginBottom: 12 }}>
        {loading ? "èª­ã¿è¾¼ã¿ä¸­..." : `${filtered.length}ä»¶ã®é€£çµ¡å…ˆ`}
      </div>

      {/* Contact List */}
      {filtered.length === 0 && !loading ? (
        <div style={{ textAlign: "center", padding: "60px 20px", opacity: 0.3 }}>
          <div style={{ fontSize: 40, marginBottom: 12 }}>ğŸ‘¤</div>
          <div style={{ fontSize: 13 }}>é€£çµ¡å…ˆãŒã‚ã‚Šã¾ã›ã‚“</div>
          <div style={{ fontSize: 11, marginTop: 4 }}>ååˆºã‚’æ’®å½±ã™ã‚‹ã‹ã€ï¼‹ãƒœã‚¿ãƒ³ã§è¿½åŠ </div>
        </div>
      ) : (
        filtered.map(c => (
          <div
            key={c.id}
            onClick={() => setSelected(c)}
            style={{
              padding: "14px 16px",
              borderRadius: 14,
              background: "rgba(255,255,255,0.04)",
              border: "1px solid rgba(255,255,255,0.06)",
              marginBottom: 8,
              cursor: "pointer",
              transition: "background 0.15s",
            }}
          >
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start" }}>
              <div>
                <div style={{ fontSize: 15, fontWeight: 600 }}>{c.name}</div>
                {c.company && (
                  <div style={{ fontSize: 12, opacity: 0.5, marginTop: 2 }}>
                    {c.company}{c.title ? ` / ${c.title}` : ""}
                  </div>
                )}
              </div>
              {c.source === "business_card" && (
                <span style={{ fontSize: 9, padding: "2px 8px", borderRadius: 6, background: "rgba(123,97,255,0.15)", color: "#B8A9FF" }}>ååˆº</span>
              )}
            </div>
            <div style={{ display: "flex", gap: 16, marginTop: 8, fontSize: 11, opacity: 0.4 }}>
              {c.phone && <span>ğŸ“ {c.phone}</span>}
              {c.mobile && <span>ğŸ“± {c.mobile}</span>}
              {c.email && <span>âœ‰ï¸ {c.email}</span>}
            </div>
          </div>
        ))
      )}

      {/* Detail Modal */}
      {selected && !editing && (
        <Modal onClose={() => setSelected(null)} accent={accent}>
          <div style={{ fontSize: 20, fontWeight: 700, marginBottom: 4 }}>{selected.name}</div>
          {selected.name_reading && <div style={{ fontSize: 12, opacity: 0.4, marginBottom: 12 }}>{selected.name_reading}</div>}

          <DetailSection label="ä¼šç¤¾" value={selected.company} />
          <DetailSection label="å½¹è·" value={selected.title} />
          <DetailSection label="éƒ¨ç½²" value={selected.department} />
          <DetailSection label="ãƒ¡ãƒ¼ãƒ«" value={selected.email} link={`mailto:${selected.email}`} />
          <DetailSection label="é›»è©±" value={selected.phone} link={`tel:${selected.phone}`} />
          <DetailSection label="æºå¸¯" value={selected.mobile} link={`tel:${selected.mobile}`} />
          <DetailSection label="FAX" value={selected.fax} />
          <DetailSection label="ã€’" value={selected.postal_code} />
          <DetailSection label="ä½æ‰€" value={selected.address} />
          <DetailSection label="Web" value={selected.website} link={selected.website} />
          <DetailSection label="è³‡æ ¼" value={selected.license} />
          {selected.notes && <DetailSection label="ãƒ¡ãƒ¢" value={selected.notes} />}

          <div style={{ fontSize: 10, opacity: 0.3, marginTop: 16 }}>
            ç™»éŒ²æ—¥: {new Date(selected.created_at).toLocaleDateString("ja-JP")}
            {selected.source === "business_card" && " (ååˆºèª­å–)"}
          </div>

          <div style={{ display: "flex", gap: 8, marginTop: 20 }}>
            <button
              onClick={() => setEditing({ ...selected })}
              style={{ flex: 1, padding: 12, borderRadius: 10, border: "none", background: `linear-gradient(135deg,${accent},${theme?.accent2 || "#7B61FF"})`, color: "#fff", fontSize: 13, fontWeight: 700, cursor: "pointer" }}
            >
              ç·¨é›†
            </button>
            <button
              onClick={() => deleteContact(selected.id)}
              style={{ padding: "12px 20px", borderRadius: 10, border: "1px solid rgba(255,59,59,0.3)", background: "rgba(255,59,59,0.08)", color: "#FF6B6B", fontSize: 13, cursor: "pointer" }}
            >
              
            </button>
          </div>
        </Modal>
      )}

      {/* Edit Modal */}
      {editing && (
        <Modal onClose={() => setEditing(null)} accent={accent}>
          <div style={{ fontSize: 14, fontWeight: 700, color: accent, marginBottom: 16, letterSpacing: 2 }}>ç·¨é›†</div>
          <EditField label="åå‰" value={editing.name} onChange={v => setEditing({ ...editing, name: v })} />
          <EditField label="ãµã‚ŠãŒãª" value={editing.name_reading} onChange={v => setEditing({ ...editing, name_reading: v })} />
          <EditField label="ä¼šç¤¾" value={editing.company} onChange={v => setEditing({ ...editing, company: v })} />
          <EditField label="å½¹è·" value={editing.title} onChange={v => setEditing({ ...editing, title: v })} />
          <EditField label="éƒ¨ç½²" value={editing.department} onChange={v => setEditing({ ...editing, department: v })} />
          <EditField label="ãƒ¡ãƒ¼ãƒ«" value={editing.email} onChange={v => setEditing({ ...editing, email: v })} />
          <EditField label="é›»è©±" value={editing.phone} onChange={v => setEditing({ ...editing, phone: v })} />
          <EditField label="æºå¸¯" value={editing.mobile} onChange={v => setEditing({ ...editing, mobile: v })} />
          <EditField label="FAX" value={editing.fax} onChange={v => setEditing({ ...editing, fax: v })} />
          <EditField label="ã€’" value={editing.postal_code} onChange={v => setEditing({ ...editing, postal_code: v })} />
          <EditField label="ä½æ‰€" value={editing.address} onChange={v => setEditing({ ...editing, address: v })} />
          <EditField label="Web" value={editing.website} onChange={v => setEditing({ ...editing, website: v })} />
          <EditField label="ãƒ¡ãƒ¢" value={editing.notes} onChange={v => setEditing({ ...editing, notes: v })} />

          <div style={{ display: "flex", gap: 8, marginTop: 20 }}>
            <button onClick={() => setEditing(null)} style={{ flex: 0.4, padding: 12, borderRadius: 10, border: "1px solid rgba(255,255,255,0.1)", background: "transparent", color: "rgba(255,255,255,0.5)", fontSize: 13, cursor: "pointer" }}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button onClick={saveEdit} style={{ flex: 1, padding: 12, borderRadius: 10, border: "none", background: `linear-gradient(135deg,${accent},${theme?.accent2 || "#7B61FF"})`, color: "#fff", fontSize: 13, fontWeight: 700, cursor: "pointer" }}>ä¿å­˜</button>
          </div>
        </Modal>
      )}

      {/* Add Modal */}
      {showAdd && (
        <AddContactModal
          onClose={() => setShowAdd(false)}
          onSave={saveNew}
          accent={accent}
          accent2={theme?.accent2 || "#7B61FF"}
        />
      )}
    </div>
  );
}

// ========================
// Sub-components
// ========================

function Modal({ children, onClose, accent }: { children: React.ReactNode; onClose: () => void; accent: string }) {
  return (
    <div style={{ position: "fixed", inset: 0, zIndex: 250 }}>
      <div onClick={onClose} style={{ position: "absolute", inset: 0, background: "rgba(0,0,0,0.6)", backdropFilter: "blur(4px)" }} />
      <div style={{
        position: "absolute", bottom: 0, left: 0, right: 0, maxHeight: "85vh", overflowY: "auto",
        background: "linear-gradient(180deg,rgba(18,20,35,0.99),rgba(12,14,28,0.99))",
        borderRadius: "24px 24px 0 0", border: "1px solid rgba(255,255,255,0.08)", padding: "24px 20px 120px"
      }}>
        <div onClick={onClose} style={{ width: 40, height: 4, borderRadius: 2, background: "rgba(255,255,255,0.15)", margin: "0 auto 20px", cursor: "pointer" }} />
        {children}
      </div>
    </div>
  );
}

function DetailSection({ label, value, link }: { label: string; value?: string; link?: string }) {
  if (!value) return null;
  return (
    <div style={{ marginBottom: 10 }}>
      <div style={{ fontSize: 10, opacity: 0.4, marginBottom: 2 }}>{label}</div>
      {link ? (
        <a href={link} style={{ fontSize: 14, color: "#4A9EFF", textDecoration: "none" }}>{value}</a>
      ) : (
        <div style={{ fontSize: 14 }}>{value}</div>
      )}
    </div>
  );
}

function EditField({ label, value, onChange }: { label: string; value: string; onChange: (v: string) => void }) {
  return (
    <div style={{ marginBottom: 10 }}>
      <div style={{ fontSize: 10, opacity: 0.4, marginBottom: 4 }}>{label}</div>
      <input
        value={value || ""}
        onChange={e => onChange(e.target.value)}
        style={{ width: "100%", padding: "8px 12px", borderRadius: 8, border: "1px solid rgba(255,255,255,0.08)", background: "rgba(255,255,255,0.04)", color: "#F0F0F5", fontSize: 13, outline: "none", boxSizing: "border-box" }}
      />
    </div>
  );
}

function AddContactModal({ onClose, onSave, accent, accent2 }: { onClose: () => void; onSave: (c: any) => void; accent: string; accent2: string }) {
  const [form, setForm] = useState({ name: "", company: "", title: "", email: "", phone: "", mobile: "" });

  return (
    <Modal onClose={onClose} accent={accent}>
      <div style={{ fontSize: 14, fontWeight: 700, color: accent, marginBottom: 16, letterSpacing: 2 }}>æ–°è¦é€£çµ¡å…ˆ</div>
      <EditField label="åå‰ *" value={form.name} onChange={v => setForm({ ...form, name: v })} />
      <EditField label="ä¼šç¤¾" value={form.company} onChange={v => setForm({ ...form, company: v })} />
      <EditField label="å½¹è·" value={form.title} onChange={v => setForm({ ...form, title: v })} />
      <EditField label="ãƒ¡ãƒ¼ãƒ«" value={form.email} onChange={v => setForm({ ...form, email: v })} />
      <EditField label="é›»è©±" value={form.phone} onChange={v => setForm({ ...form, phone: v })} />
      <EditField label="æºå¸¯" value={form.mobile} onChange={v => setForm({ ...form, mobile: v })} />

      <div style={{ display: "flex", gap: 8, marginTop: 20 }}>
        <button onClick={onClose} style={{ flex: 0.4, padding: 12, borderRadius: 10, border: "1px solid rgba(255,255,255,0.1)", background: "transparent", color: "rgba(255,255,255,0.5)", fontSize: 13, cursor: "pointer" }}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button
          onClick={() => { if (form.name.trim()) onSave(form); }}
          disabled={!form.name.trim()}
          style={{ flex: 1, padding: 12, borderRadius: 10, border: "none", background: form.name.trim() ? `linear-gradient(135deg,${accent},${accent2})` : "rgba(255,255,255,0.06)", color: "#fff", fontSize: 13, fontWeight: 700, cursor: "pointer" }}
        >è¿½åŠ </button>
      </div>
    </Modal>
  );
}
